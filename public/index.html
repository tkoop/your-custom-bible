<!DOCTYPE html><html>

<head>
	<meta name="encoding" content="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#ececb2ff">
	<title>Your Custom Bible</title>
	<link rel="stylesheet" href="style.css" />
	<link rel="icon" type="image/png" href="images/logo.png" />
	<link rel="manifest" href="manifest.json">
</head>

<body>
	<div id="header">
		<svg id="menuIcon" onclick="showDropDown(event)" xmlns="http://www.w3.org/2000/svg"
			xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="24" height="24" viewBox="0 0 24 24">
			<path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" />
		</svg>

		<div id="dropdown" style="text-align:left">

			<div onclick="indexClicked()">Index</div>

			<div onclick="historyClicked()">History</div>

			<div style="display:flex" onclick="var i = this.querySelector('input').click(); event.stopPropagation()">
				<div>Titles</div>
				<div><input type="checkbox" data-value="titles" onchange="setSetting(this.checked, 'titles')" onclick="event.stopPropagation()"></div>
			</div>

			<div style="display:flex" onclick="var i = this.querySelector('input').click(); event.stopPropagation()">
				<div>Verses</div>
				<div><input type="checkbox" data-value="verses" onchange="setSetting(this.checked, 'verses')" onclick="event.stopPropagation()"></div>
			</div>

			<div style="display:flex" onclick="var i = this.querySelector('input').click(); event.stopPropagation()">
				<div>References</div>
				<div><input type="checkbox" data-value="references" onchange="setSetting(this.checked, 'references')" onclick="event.stopPropagation()"></div>
			</div>

			<div style="display:flex" onclick="var i = this.querySelector('input').click(); event.stopPropagation()">
				<div>Footnotes</div>
				<div><input type="checkbox" data-value="footnotes" onchange="setSetting(this.checked, 'footnotes')" onclick="event.stopPropagation()"></div>
			</div>

			<div style="display:flex">
				<div>Spelling</div>
				<div><select style="padding: 6px; border-radius: 6px; background-color: #c3c3ff;" id="spelling" onclick="event.stopPropagation()" onchange="setSetting(this.options[this.selectedIndex].value, 'spelling'); event.stopPropagation()">
					<option value="ca">Canadian</option>
					<option value="gb">British</option>
					<option value="us">USA</option>
				</select>
				</div>
			</div>

			<div style="display:flex">
				<div>Case</div>
				<div><select style="padding: 6px; border-radius: 6px; background-color: #c3c3ff;" id="case" onclick="event.stopPropagation()" onchange="setSetting(this.options[this.selectedIndex].value, 'case'); event.stopPropagation()">
					<option value="lower">Lower case</option>
					<option value="upper">Upper case</option>
				</select>
				</div>
			</div>

			<div style="display:flex">
				<div>God's Name</div>
				<div><select style="padding: 6px; border-radius: 6px; background-color: #c3c3ff;" id="name" onclick="event.stopPropagation()" onchange="setSetting(this.options[this.selectedIndex].value, 'name'); event.stopPropagation()">
					<option value="Yahweh" data-letter="Y">Yahweh</option>
					<option value="LORD" data-letter="L">LORD</option>
					<option value="Jehovah" data-letter="J">Jehovah</option>
					<option value="YHWH" data-letter="W">YHWH</option>
					<option value="YHVH" data-letter="V">YHVH</option>
					<option value="HaShem" data-letter="H">HaShem</option>
					<option value="Adonai" data-letter="A">Adonai</option>
					<option value="Elohim" data-letter="E">Elohim</option>
					<option value="G-d" data-letter="D">G-d</option>
					<option value="God" data-letter="G">God</option>
				</select>
				</div>
			</div>

			<div>
				<div>Font Size</div>
				<div class="buttonHolder">
					<button onclick="fontSize(1.1, event); event.stopPropagation()">+</button> 
					<button onclick="fontSize(0.9091, event); event.stopPropagation()">-</button>
				</div>
			</div>

			<div>
				<div>Mode</div>
				<div class="buttonHolder">
					<button onclick="darkMode(true); event.stopPropagation()">Dark</button> 
					<button onclick="darkMode(false); event.stopPropagation()">Light</button>
				</div>
			</div>

			<div onclick="aboutClicked()">About</div>


			<!-- <div onclick="aboutClicked(); hideDropDown()">About</div> -->
		</div>

		<!--
		<h2 onclick="indexClicked()" style="margin-top:-12px; cursor:pointer; font-family: 'Cairo', sans-serif;">Your Custom Bible</h2>
		-->
		<img onclick="indexClicked()" src="images/banner.png" style="cursor: pointer; height: 88%; margin-top: -4px;">

	</div>
	<div id="body" style="font-family: 'Sawarabi Mincho', sans-serif;">
		<div id="index" class="page" style="display:block"></div>
		<div id="history" class="page">History page</div>
		<div id="about" class="page"></div>
		<div id="chapter" class="page"></div>
	</div>
</body>

<script src="books.js"></script>

<script>
	var browseHistory = []
	var currentBookIndex = 0
	var currentChapter = 1 // one based

	function applySettings() {
		// Titles
		if (document.querySelectorAll("input[data-value=titles]:checked").length > 0) {
			document.querySelectorAll(".hdg").forEach(el => el.style.display = null)
		} else {
			document.querySelectorAll(".hdg").forEach(el => el.style.display = "none")
		}

		// Verses
		if (document.querySelectorAll("input[data-value=verses]:checked").length > 0) {
			document.querySelectorAll(".reftext").forEach(el => el.style.display = null)
		} else {
			document.querySelectorAll(".reftext").forEach(el => el.style.display = "none")
		}

		// Cross references
		if (document.querySelectorAll("input[data-value=references]:checked").length > 0) {
			document.querySelectorAll(".cross1").forEach(el => el.style.display = null)
		} else {
			document.querySelectorAll(".cross1").forEach(el => el.style.display = "none")
		}

		// Verses
		if (document.querySelectorAll("input[data-value=footnotes]:checked").length > 0) {
			document.querySelectorAll(".fn").forEach(el => el.style.display = null)
		} else {
			document.querySelectorAll(".fn").forEach(el => el.style.display = "none")
		}

		// Spelling
		var spellingSelect = document.querySelector("#spelling")
		var spellingCountry = spellingSelect.options[spellingSelect.selectedIndex].value
		document.querySelectorAll(".spell").forEach(el => el.style.display = "none")
		document.querySelectorAll(".spell."+spellingCountry).forEach(el => el.style.display = "inline")

		// Case
		var caseSelect = document.querySelector("#case")
		var caseSetting = caseSelect.options[caseSelect.selectedIndex].value
		if (caseSetting == 'lower') {
			document.querySelectorAll(".cap").forEach(el => el.style.display = "none")
			document.querySelectorAll(".nocap").forEach(el => el.style.display = "inline")
		} else {
			document.querySelectorAll(".cap").forEach(el => el.style.display = "inline")
			document.querySelectorAll(".nocap").forEach(el => el.style.display = "none")
		}
		
		// God's name
		var nameSelect = document.querySelector("#name")
		var name = nameSelect.options[nameSelect.selectedIndex].value
		if (name == "LORD") {
			document.querySelectorAll(".lord").forEach(el => el.innerHTML = el.dataset.name)
			document.querySelectorAll(".caplord").forEach(el => el.innerHTML = el.dataset.name)
		} else {
			document.querySelectorAll(".lord").forEach(el => el.innerHTML = name)
			document.querySelectorAll(".caplord").forEach(el => el.innerHTML = name.toUpperCase())
		}

		if (document.querySelectorAll(".version")) {
			document.querySelectorAll(".version").forEach(el => el.innerHTML = getVersion())
		}
	}

	function setSetting(value, name) {
		if (localStorage.settings == undefined) localStorage.settings = "{}"
		var settings = JSON.parse(localStorage.settings)
		settings[name] = value

		localStorage.settings = JSON.stringify(settings)
		applySettings()
	}

	for(key in JSON.parse(localStorage.settings ?? "{}")) {
		var value = JSON.parse(localStorage.settings ?? "{}")[key]
		if (key == "spelling" || key == "name" || key == "case") {
			document.querySelectorAll("select#"+key+" option").forEach(op => {
				if (op.value == value) {
					op.selected = true
				}
			})
		} else {
			document.querySelector("input[data-value="+key+"]").checked = value
		}
	}
	applySettings()

	function darkMode(dark) {
		localStorage.mode = dark ? "dark" : "light"

		if (dark) {
			document.body.classList.add("dark")
		} else {
			document.body.classList.remove("dark")
		}
	}

	darkMode(localStorage.mode == "dark")

	function fontSize(scale, event) {
		var size = localStorage.fontSize
		if (size == undefined) size = 16
		size = parseFloat(size)
		size = size * scale
		localStorage.fontSize = size
		document.getElementById("body").style.fontSize = size + "px"

		if (event) {
			event.stopImmediatePropagation()
			event.stopPropagation()
			event.preventDefault()
		}
	}

	fontSize(1)

	if (localStorage.browseHistory != undefined) {
		browseHistory = JSON.parse(localStorage.browseHistory)
	}

	window.addEventListener('popstate', (event) => {
		if (event.state == null || event.state == "index") {
			showPage("index")
		} else if (event.state == "history") {
			showPage("history")
		} else {
			loadURL(event.state)
		}
	})

	window.addEventListener('click', (event) => {
		hideDropDown()
	})

	function showDropDown(event) {
		event.stopPropagation()
		document.getElementById("dropdown").style.display = "block"
	}

	function hideDropDown() {
		document.getElementById("dropdown").style.display = "none"
	}

	function slugToIndex(slug) {
		for (var i = 0; i < books.length; i++) {
			if (books[i].slug == slug) {
				return i
			}
		}
		return 0
	}

	function aboutClicked() {
		history.pushState('about', '')
		showPage("about")

		fetch("about.html").then(function (response) {
			return response.text()
		}).then(function (text) {
			document.getElementById("about").innerHTML = text
		})
	}

	function checkUpdates() {
		if ('serviceWorker' in navigator) {
			navigator.serviceWorker.getRegistrations().then(function(registrations) {
				for(let registration of registrations) {
					console.log("Calling unregister.") 
					registration.unregister()
				}
				window.location.reload()
			}).catch(function(err) {
				console.log('Service Worker registration failed: ', err);
			});
		} else {
			console.log("service workers not supported.")
			window.location.reload()
		}
	}

	function historyClicked() {
		history.pushState('history', '')
		showPage("history")

		let html = "<h2>History</h2>"
		let previousDate = null
		let dateString = null

		if (browseHistory.length == 0) {
			html += "<p style='font-style:italic'>No history</p>"
		} else {
			for (let i = browseHistory.length - 1; i >= 0; i--) {
				if (browseHistory[i].date != previousDate) {
					if (html.substr(html.length - 2) == ', ') {
						html = html.substr(0, html.length - 2)
					}
					previousDate = browseHistory[i].date
					dateString = new Date(Date.parse(browseHistory[i].date)).toLocaleDateString('en-CA', {
						month: 'short', // this order has nothing to do with the output
						day: 'numeric',
						year: 'numeric'
					})
					html += "</p><h3>" + dateString + "</h3><p>"
				}
				html += createLink(browseHistory[i].name, browseHistory[i].slug, browseHistory[i].chapter, true) + ", "
			}
		}
		if (html.substr(html.length - 2) == ', ') {
			html = html.substr(0, html.length - 2)
		}

		document.getElementById("history").innerHTML = html
		window.scrollTo(0, 0)
	}

	function indexClicked() {
		history.pushState('index', '')
		showPage("index")
	}

	function showPage(page) {
		document.querySelectorAll(".page").forEach(e => e.style.display = "none")
		document.getElementById(page).style.display = "block"
		window.scrollTo(0, 0)
	}

	function loadChapter(element) {
		var book = element.dataset.book
		var slug = element.dataset.slug
		var chapter = element.dataset.chapter
		loadThisChapter(book, slug, chapter)
	}

	function loadThisChapter(book, slug, chapter) {
		var url = "./chapters/" + slug + "-" + chapter + ".html"
		history.pushState(url, '')
		loadURL(url)

		browseHistory.push({
			name: book,
			slug: slug,
			chapter: chapter,
			date: ((new Date()) + '').substr(0, 10)
		})

		localStorage.browseHistory = JSON.stringify(browseHistory)
		currentBookIndex = slugToIndex(slug)
		currentChapter = chapter
		window.scrollTo(0, 0)
	}

	function moveChapter(delta) {
		currentChapter = parseInt(currentChapter) + parseInt(delta)
		if (currentChapter < 1) {
			currentBookIndex--
			if (currentBookIndex < 0) {
				// went left from Genesis
				currentBookIndex = books.length - 1
			}
			currentChapter = books[currentBookIndex].chapters
		}
		if (currentChapter > books[currentBookIndex].chapters) {
			currentBookIndex++
			if (currentBookIndex >= books.length) {
				// went right from Revelation
				currentBookIndex = 0
			}
			currentChapter = 1
		}

		loadThisChapter(books[currentBookIndex].name, books[currentBookIndex].slug, currentChapter)
	}

	function titleCase(str) {
		return str.toLowerCase().split(' ').map(function(word) {
			return word.replace(word[0], word[0].toUpperCase());
		}).join(' ');
	}

	function loadURL(url) {
		showPage("chapter")
		fetch(url).then(function (response) {
			return response.text()
		}).then(function (text) {
			var chapter = document.getElementById("chapter")
			var title = url.substr(11, url.length-16)
			title = titleCase(title.replaceAll("-", " "))
			title = title.replace(" Of ", " of ")	// Song of Solomon
			title = title + " (<span class='version'></span>)"
			chapter.innerHTML = addArrows(text, title)
			applySettings()
		})
	}

	function getVersion() {
		var spellingSelect = document.querySelector("#spelling")
		var spellingCountry = spellingSelect.options[spellingSelect.selectedIndex].value
		var letter = spellingCountry.substr(0,1).toUpperCase()
		if (letter == "G") letter = "B"

		var nameSelect = document.querySelector("#name")
		var nameLetter = nameSelect.options[nameSelect.selectedIndex].dataset.letter

		return "YCB-" + letter + nameLetter
	}

	function addArrows(html,  title) {
		var arrows = `<div style="display: flex; justify-content: space-between;">
			<svg onclick="moveChapter(-1)" style="color:#b9b9b9; cursor:pointer; width:34px;height:34px" viewBox="0 0 24 24">
				<path fill="currentColor" d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z" />
			</svg>
			<div id="chapterTitle">${title}</div>
			<svg onclick="moveChapter(1)" style="color:#b9b9b9; cursor:pointer; width:34px;height:34px" viewBox="0 0 24 24">
				<path fill="currentColor" d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" />
			</svg>
		</div>`

		return arrows + html + "<div style='height:20px'></div>" + arrows
	}

	function createLink(name, slug, chapter, includeBook) {
		if (includeBook) {
			return `<a href='#' style='white-space:nowrap' data-slug='${slug}' data-book='${name}' data-chapter='${chapter}' onclick='loadChapter(this); return false'>${name} ${chapter}</a>`
		} else {
			return `<a href='#' data-slug='${slug}' data-book='${name}' data-chapter='${chapter}' onclick='loadChapter(this); return false'>${chapter}</a>`
		}
	}

	books.forEach(function (book) {
		var bookDiv = document.createElement("div");
		bookDiv.innerHTML = "<div class='index-book'>" + book.name + "</div>";
		var chapterLinks = "<div class='index-chapters'>"
		for (let i = 1; i <= book.chapters; i++) {
			chapterLinks += createLink(book.name, book.slug, i) + " "
		}
		chapterLinks += "</div>"
		bookDiv.innerHTML += chapterLinks;
		document.getElementById("index").appendChild(bookDiv);
	});

	if (browseHistory.length > 0) {
		let history = browseHistory[browseHistory.length - 1]

		var url = "./chapters/" + history.slug + "-" + history.chapter + ".html"
		loadURL(url)
		currentChapter = history.chapter
		currentBookIndex = slugToIndex(history.slug)
	}

</script>

<script>
	if (window.location.hostname != "localhost") {
		if ('serviceWorker' in navigator) {
			window.addEventListener('load', function () {
				navigator.serviceWorker.register('./serviceWorker.js', {
					scope: "./"
				}).then(function (registration) {
					console.log('ServiceWorker registered successfully, scope: ', registration.scope);
				}, function (err) {
					console.log('ServiceWorker registration failed: ', err);
				});
				window.IS_STANDALONE = window.matchMedia('(display-mode: standalone)').matches;
			});
		}
	}

</script>

</html>
